<template>
    <div class="dragDropId">
        <!-- Header -->
        <div class="app-header">
            <h1>üöö Delivery Planning Dashboard</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick={handleRefresh}><span>‚Üª</span> Refresh</button>
                <!-- <button class="btn btn-secondary"><span>üìä</span> Reports</button>
                <button class="btn btn-secondary"><span>‚öôÔ∏è</span> Settings</button> -->
            </div>
        </div>

        <!-- Toolbar for main page -->
        <div class="toolbar">
            <div class="filter-section left-side">
                <label>Customer:</label>
                <select name="customer" onchange={handleCustomerChange}>
                    <option value="all">All Customers</option>
                    <template for:each={accounts} for:item="acc">
                        <option key={acc.Id} value={acc.Id}>{acc.Abbreviation__c}</option>
                    </template>
                </select>
                <label>Week</label>
                <input type="date" value={selectedDate} oninput={handleDateChange}>
            </div>
            <!-- stats section part -->
            <div class="stats-section right-side">
                <div class=" stat-item">
                    <div class="stat-value">{countPendingFulfillments}</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class=" stat-item">
                    <div class="stat-value">{countAssignedFulfillments}</div>
                    <div class="stat-label">Assigned</div>
                </div>
                <div class=" stat-item">
                    <div class="stat-value">{countConfirmedFulfillments}</div>
                    <div class="stat-label">Confirmed</div>
                </div>
                <!-- 
                    <div class=" stat-item">
                        <div class="stat-value">87%</div>
                        <div class="stat-label">Utilization</div>
                    </div>
                -->
            </div>

        </div>

        <!-- Marker Capacity -->
        <div class="legend flex flex-row justify-between">
            <div class="legend-item">
                <div class="legend-item">
                    <div class="legend-color" style="background: #fc5b5b;"></div>
                    <span>Pending</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #0176d3;"></div>
                    <span>Assigned</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2e844a;"></div>
                    <span>Confirmed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #18619c;"></div>
                    <span>Others</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF0000;"></div>
                    <span>Error</span>
                </div>

            </div>
            <div class="legend-item">
                <div class="legend-item">
                    <div class="legend-color" style="background: #2e844a;"></div>
                    <span>Under Capacity</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffa500;"></div>
                    <span>Near Capacity</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #c23934;"></div>
                    <span>At Capacity</span>
                </div>
            </div>
        </div>


        <div class="scheduler-container">

            <!-- LEFT SIDE - ORDERS -->
            <div class="orders-panel">
                <div class="panel-header">
                    <h2>üìã Pending Fulfillments ({countPendingFulfillments})</h2>
                    <button class="btn btn-success w-100" onclick={openModal}>‚ú® AI Auto-Schedule Selected
                        ({countSelectedCheckbox})</button>
                    <!-- <button class="btn btn-primary mt-4 w-100">Submit</button> -->
                </div>

                <template for:each={pendingOrders} for:item="o">
                    <div key={o.id} class="order-card" draggable="true" data-id={o.id} data-name={o.name}
                        ondragstart={handleDragStart}>
                        <div class="header-card">
                            <lightning-formatted-url value={o.url} label={o.name} target="_blank">
                            </lightning-formatted-url>
                            <input type="checkbox" checked={o.checked} onchange={handleCheckbox} data-name={o.name} />
                        </div>
                        <div class="line-card flex flex-col" style="margin-bottom: 5px;">
                            <div class="flex flex-row justify-between">
                                <span class="">{o.customer} |
                                    {o.orderNumber}</span>
                                <lightning-helptext content={o.orderNumber}></lightning-helptext>
                            </div>
                        </div>
                        <div class="separator"></div>
                        <div class="line-card flex flex-col justify-between">
                            <template for:each={o.products} for:item="item">
                                <div key={item.Id} class="mt-2">
                                    <div class="flex flex-row justify-between w-100">
                                        <span>ProductCode: <br />{item.Product_Code__c}</span>
                                        <span>Quantity: <br />{item.Quantity__c}</span>
                                        <lightning-helptext content={item.Product_Code__c}></lightning-helptext>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div class="order-weight">{o.weight} kg</div>


                    </div>
                </template>
            </div>

            <!-- RIGHT SIDE - CALENDAR -->
            <div class="calendar-panel">
                <template for:each={calendarData} for:item="day">
                    <div key={day.date} class="day-column">

                        <div class="day-header">
                            <div class="day-name">{day.dayName}</div>
                            <div class="day-date">{day.date}</div>
                        </div>

                        <template for:each={day.trucks} for:item="t">
                            <div key={t.truckId} class="truck-card" data-truck-id={t.truckId} data-date={day.date}
                                ondragover={handleDragOver} ondrop={handleDrop}>

                                <div class="truck-header">
                                    <div class="flex flex-row">
                                        <div class="truck-name truncate">{t.truckName} </div>
                                        <lightning-helptext content={t.tooltip}></lightning-helptext>
                                    </div>
                                    <div class={t.statusClass}>{t.remainingCapacity} kg</div>
                                </div>

                                <div class="truck-orders">
                                    <template for:each={t.assignedOrders} for:item="ord">
                                        <div key={ord} class={ord.cssClass}>
                                            <div class="flex justify-between">
                                                <a href={ord.url} target="_blank" class="white-url">
                                                    {ord.name}
                                                </a>
                                                <button class="remove-btn" data-id={ord.id} data-truck-id={t.truckId}
                                                    data-date={day.date} onclick={handleRemove}>
                                                    ‚úï
                                                </button>
                                            </div>
                                            <div>
                                                <label for="" class="truncate">
                                                    {ord.customer} | {ord.orderNumber}
                                                </label>
                                            </div>
                                            <div class="">
                                                <template for:each={ord.products} for:item="item">
                                                    <div key={item.Id} class="mt-2">
                                                        <div class="flex flex-row justify-between w-100">
                                                            <span>ProductCode:<br /> {item.Product_Code__c}</span>
                                                            <span>Quantity:<br /> {item.Quantity__c}</span>
                                                            <lightning-helptext
                                                                content={item.Product_Code__c}></lightning-helptext>
                                                        </div>
                                                        <!-- <div class="order-weight">{item.Total_Weight__c} kg</div> -->
                                                    </div>
                                                </template>
                                            </div>
                                            <div class="">
                                                <div class="order-weight">{ord.weight} kg</div>
                                            </div>

                                        </div>
                                    </template>

                                    <template if:true={t.isEmpty}>
                                        <div class="empty-hint">Drop orders here</div>
                                    </template>
                                </div>

                            </div>
                        </template>
                    </div>
                </template>
            </div>

        </div>

    </div>

    <!-- MODAL: AI Auto-Schedule -->
    <template if:true={showModal}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">

                <!-- HEADER -->
                <header class="slds-modal__header">
                    <h2 class="slds-modal__title">AI Auto-Schedule Preview</h2>
                </header>

                <!-- BODY -->
                <div class="slds-modal__content slds-p-around_medium">
                    <p><strong>Week:</strong> {weekStart} to {weekEnd}</p>

                    <h3 class="slds-m-top_medium">Selected Orders</h3>


                    <lightning-datatable key-field="id" data={selectedOrders} columns={orderColumns}
                        hide-checkbox-column="true" class="slds-m-top_small">
                    </lightning-datatable>

                </div>

                <!-- FOOTER -->
                <footer class="slds-modal__footer">
                    <button class="slds-button slds-button_neutral" onclick={closeModal}>Cancel</button>
                    <button class="slds-button slds-button_brand" onclick={confirmAISchedule}>
                        Confirm Auto-Schedule
                    </button>
                </footer>

            </div>
        </section>

        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
    <template if:true={showFlow}>
        <section role="dialog" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <h2 class="slds-text-heading_medium">AI Scheduling Flow</h2>
                    <button class="slds-button slds-modal__close" onclick={closeFlowModal}>X</button>
                </header>

                <div class="slds-modal__content">
                    <lightning-flow flow-api-name={flowName} flow-input-variables={inputVariables}
                        onstatuschange={handleFlowStatus}>
                    </lightning-flow>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
    <template if:true={isLoading}>
        <section role="dialog" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container ">
                <div class="slds-modal__content slds-align_absolute-center">

                    <div class="slds-p-around_x-large slds-text-align_center">
                        <div class="slds-text-heading_large slds-m-bottom_medium">
                            AI Scheduling in Progress
                        </div>

                        <lightning-spinner size="large" variant="brand"></lightning-spinner>

                        <div class="slds-m-top_large slds-text-heading_medium">
                            Optimizing delivery routes and capacity
                        </div>

                        <div class="slds-text-body_regular slds-text-color_weak slds-m-top_small">
                            Please keep this window open. This process may take several minutes.
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
    <template if:true={showResultAIScheduleModal}>
        <section role="dialog" class="slds-modal slds-fade-in-open slds-modal_x-large">
            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <h2 class="slds-text-heading_medium">AI Scheduling Result</h2>
                    <button class="slds-button slds-modal__close" onclick={closeResultModal}>‚úï</button>
                </header>

                <div class="slds-modal__content slds-p-around_medium">
                    <h3 class="slds-text-heading_small slds-m-bottom_small">
                        Scheduling Execution Details
                    </h3>

                    <lightning-datatable key-field="Id" data={schedulingLogItems} columns={schedulingLogColumns}
                        hide-checkbox-column resize-column-disabled>
                    </lightning-datatable>
                    <h3 class="slds-text-heading_small slds-m-top_large slds-m-bottom_small">
                        Delivery Condition Evaluation
                    </h3>

                    <lightning-datatable key-field="Id" data={deliveryConditionItems} columns={deliveryConditionColumns}
                        hide-checkbox-column resize-column-disabled>
                    </lightning-datatable>
                </div>
                <footer class="slds-modal__footer">
                    <button class="slds-button slds-button_brand" onclick={closeResultModal}>
                        Close
                    </button>
                </footer>
            </div>
        </section>

        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>



</template>